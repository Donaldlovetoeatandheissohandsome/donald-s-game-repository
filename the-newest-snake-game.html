<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donaldma Snake Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            background-color: #1a1a1a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }
        #modeSelect {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #333;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            z-index: 100;
        }
        #modeSelect h2 {
            color: #fff;
            margin-bottom: 20px;
        }
        .modeBtn {
            padding: 15px 30px;
            margin: 10px;
            font-size: 18px;
            background-color: #00ff00;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .modeBtn:hover {
            background-color: #00cc00;
        }
        #gameCanvas {
            border: 2px solid #00ff00;
            background-color: #000;
        }
        #joystick {
            display: none;
            position: absolute;
            bottom: 30px;
            left: 30px;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            touch-action: none;
        }
        #stick {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #00ff00;
            transform: translate(-50%, -50%);
            touch-action: none;
        }
    </style>
</head>
<body>
    <!-- è¨­å‚™é¸æ“‡ç•Œé¢ -->
    <div id="modeSelect">
        <h2>é¸æ“‡éŠæˆ²æ¨¡å¼</h2>
        <button id="computerBtn" class="modeBtn">é›»è…¦æ¨¡å¼ (WASD/æ–¹å‘éµ)</button>
        <button id="tabletBtn" class="modeBtn">å¹³æ¿æ¨¡å¼ (è§¸æ‘¸æ–æ¡¿)</button>
    </div>

    <!-- éŠæˆ²ç•«å¸ƒ -->
    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <!-- å¹³æ¿æ¨¡å¼æ–æ¡¿ -->
    <div id="joystick">
        <div id="stick"></div>
    </div>

    <script>
        // æ ¸å¿ƒéŠæˆ²è®Šé‡
        let canvas, ctx;
        let snake, direction, food;
        let score = 0;
        let gameOver = false;
        let isComputerMode = true; // é»˜èªé›»è…¦æ¨¡å¼
        let touchJoystick = { x: 0, y: 0, isPressed: false };

        // è›‡ç³§ç”Ÿæˆæ¦‚ç‡ï¼ˆé»˜èª1%ï¼Œå¯†ç¢¼æ­£ç¢ºå¾Œ90%ï¼‰
        let foodSpawnRate = 0.01; 
        // å¯†ç¢¼é…ç½®
        const SECRET_PASSWORD = "bryananddonald";
        let inputPassword = ""; // å­˜å„²ç©å®¶è¼¸å…¥çš„å¯†ç¢¼

        // åˆå§‹åŒ–éŠæˆ²
        function initGame() {
            canvas = document.getElementById("gameCanvas");
            ctx = canvas.getContext("2d");
            
            // ç¶å®šè¨­å‚™é¸æ“‡æŒ‰éˆ•äº‹ä»¶
            document.getElementById("computerBtn").addEventListener("click", () => {
                isComputerMode = true;
                document.getElementById("modeSelect").style.display = "none";
                resetGame();
            });
            document.getElementById("tabletBtn").addEventListener("click", () => {
                isComputerMode = false;
                document.getElementById("modeSelect").style.display = "none";
                resetGame();
                initJoystick(); // åˆå§‹åŒ–è§¸æ‘¸æ–æ¡¿
            });

            // ç›£è½å…¨åŸŸéµç›¤è¼¸å…¥ï¼ˆå¯†ç¢¼+ç§»å‹•æ§åˆ¶ï¼‰
            document.addEventListener("keydown", handleKeyInput);
            
            // Chrome å…¼å®¹æ€§ä¿®å¾©
            document.addEventListener('touchstart', function(e) {}, { passive: false });
            document.addEventListener('touchmove', function(e) {}, { passive: false });
        }

        // è™•ç†éµç›¤è¼¸å…¥ï¼ˆå¯†ç¢¼é©—è­‰ + ç§»å‹•æ§åˆ¶ï¼‰
        function handleKeyInput(e) {
            // 1. å¯†ç¢¼è¼¸å…¥é‚è¼¯ï¼ˆåƒ…æ¥æ”¶å­—æ¯ï¼Œä¸åˆ†å¤§å°å¯«ï¼‰
            const key = e.key.toLowerCase();
            if (/^[a-z]$/.test(key)) {
                inputPassword += key;
                // æˆªæ–·å¤šé¤˜å­—ç¬¦ï¼Œåªä¿ç•™å¯†ç¢¼é•·åº¦çš„æœ€å¾Œå¹¾ä½
                if (inputPassword.length > SECRET_PASSWORD.length) {
                    inputPassword = inputPassword.slice(-SECRET_PASSWORD.length);
                }
                // é©—è­‰å¯†ç¢¼ä¸¦æ›´æ–°æ¦‚ç‡
                if (inputPassword === SECRET_PASSWORD) {
                    foodSpawnRate = 0.9; // æå‡è‡³90%
                    inputPassword = ""; // é‡ç½®è¼¸å…¥æ¡†
                    alert("å¯†ç¢¼æ­£ç¢ºï¼è›‡ç³§ç”Ÿæˆæ¦‚ç‡å·²æå‡è‡³90% ğŸ‰");
                }
            }

            // 2. é›»è…¦æ¨¡å¼ç§»å‹•æ§åˆ¶ï¼ˆéŠæˆ²æœªçµæŸæ™‚ï¼‰
            if (isComputerMode && !gameOver) {
                switch(e.key) {
                    case "ArrowUp":
                    case "w":
                    case "W":
                        if (direction !== "down") direction = "up";
                        break;
                    case "ArrowDown":
                    case "s":
                    case "S":
                        if (direction !== "up") direction = "down";
                        break;
                    case "ArrowLeft":
                    case "a":
                    case "A":
                        if (direction !== "right") direction = "left";
                        break;
                    case "ArrowRight":
                    case "d":
                    case "D":
                        if (direction !== "left") direction = "right";
                        break;
                    case " ": // ç©ºæ ¼éµé‡å•ŸéŠæˆ²
                        if (gameOver) resetGame();
                        break;
                }
            }
        }

        // åˆå§‹åŒ–å¹³æ¿æ¨¡å¼æ–æ¡¿
        function initJoystick() {
            const joystick = document.getElementById("joystick");
            const stick = document.getElementById("stick");
            
            joystick.style.display = "block";
            const joystickRect = joystick.getBoundingClientRect();
            const joystickRadius = joystickRect.width / 2;

            // è§¸æ‘¸é–‹å§‹
            joystick.addEventListener("touchstart", (e) => {
                touchJoystick.isPressed = true;
                updateJoystickPosition(e.touches[0]);
            });

            // è§¸æ‘¸ç§»å‹•
            document.addEventListener("touchmove", (e) => {
                if (touchJoystick.isPressed) {
                    updateJoystickPosition(e.touches[0]);
                }
            });

            // è§¸æ‘¸çµæŸ
            document.addEventListener("touchend", () => {
                touchJoystick.isPressed = false;
                touchJoystick.x = 0;
                touchJoystick.y = 0;
                stick.style.transform = "translate(0,0)";
            });

            // æ›´æ–°æ–æ¡¿ä½ç½®å’Œè›‡ç§»å‹•æ–¹å‘
            function updateJoystickPosition(touch) {
                const x = touch.clientX - joystickRect.left - joystickRadius;
                const y = touch.clientY - joystickRect.top - joystickRadius;
                const distance = Math.sqrt(x * x + y * y);

                // é™åˆ¶æ–æ¡¿ç§»å‹•ç¯„åœ
                if (distance > joystickRadius) {
                    touchJoystick.x = (x / distance) * joystickRadius;
                    touchJoystick.y = (y / distance) * joystickRadius;
                } else {
                    touchJoystick.x = x;
                    touchJoystick.y = y;
                }

                // æ›´æ–°æ–æ¡¿è¦–è¦ºä½ç½®
                stick.style.transform = `translate(${touchJoystick.x}px, ${touchJoystick.y}px)`;

                // åˆ¤æ–·ç§»å‹•æ–¹å‘
                if (Math.abs(touchJoystick.y) > Math.abs(touchJoystick.x)) {
                    direction = touchJoystick.y < 0 ? "up" : "down";
                } else {
                    direction = touchJoystick.x > 0 ? "right" : "left";
                }
            }
        }

        // é‡ç½®éŠæˆ²ç‹€æ…‹
        function resetGame() {
            // é‡ç½®è›‡çš„åˆå§‹ä½ç½®
            snake = [
                { x: 10, y: 10 },
                { x: 9, y: 10 },
                { x: 8, y: 10 }
            ];
            direction = "right";
            score = 0;
            gameOver = false;
            foodSpawnRate = 0.01; // é‡ç½®è›‡ç³§æ¦‚ç‡ç‚º1%
            spawnFood(); // ç”Ÿæˆåˆå§‹è›‡ç³§
            gameLoop(); // å•Ÿå‹•éŠæˆ²å¾ªç’°
        }

        // ç”Ÿæˆè›‡ç³§ï¼ˆåŸºæ–¼ç•¶å‰æ¦‚ç‡ï¼‰
        function spawnFood() {
            // æ ¹æ“šæ¦‚ç‡åˆ¤æ–·æ˜¯å¦ç”Ÿæˆè›‡ç³§
            if (Math.random() > foodSpawnRate) {
                food = null;
                return;
            }

            // éš¨æ©Ÿç”Ÿæˆè›‡ç³§ä½ç½®ï¼ˆé¿é–‹è›‡èº«ï¼‰
            do {
                food = {
                    x: Math.floor(Math.random() * canvas.width / 20),
                    y: Math.floor(Math.random() * canvas.height / 20),
                    type: getRandomFoodType() // éš¨æ©Ÿè›‡ç³§é¡å‹
                };
            } while (snake.some(segment => segment.x === food.x && segment.y === food.y));
        }

        // éš¨æ©Ÿé¸æ“‡è›‡ç³§é¡å‹ï¼ˆåŠ æ¬Šæ¦‚ç‡ï¼‰
        function getRandomFoodType() {
            const types = ["apple", "blueberry", "strawberry", "colorful"];
            const weights = [0.6, 0.2, 0.15, 0.05]; // è˜‹æœ60%ã€è—è“20%ã€è‰è“15%ã€è®Šè‰²ç³§5%
            let randomValue = Math.random();
            let weightSum = 0;

            for (let i = 0; i < types.length; i++) {
                weightSum += weights[i];
                if (randomValue <= weightSum) {
                    return types[i];
                }
            }
            return "apple"; // é»˜èªè˜‹æœ
        }

        // ç¹ªè£½éŠæˆ²ç•«é¢
        function drawGame() {
            // æ¸…ç©ºç•«å¸ƒ
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // éŠæˆ²çµæŸç•«é¢
            if (gameOver) {
                ctx.fillStyle = "#ff0000";
                ctx.font = "30px Arial";
                ctx.textAlign = "center";
                ctx.fillText("éŠæˆ²çµæŸï¼åˆ†æ•¸ï¼š" + score, canvas.width/2, canvas.height/2);
                ctx.fillText("æŒ‰ç©ºæ ¼éµé‡å•ŸéŠæˆ²", canvas.width/2, canvas.height/2 + 40);
                return;
            }

            // ç¹ªè£½è›‡
            snake.forEach((segment, index) => {
                // è®Šè‰²è›‡ç³§æ•ˆæœï¼šè›‡é ­é¡è‰²éš¨æ©Ÿ
                if (food && food.type === "colorful" && index === 0) {
                    ctx.fillStyle = `hsl(${Math.random() * 360}, 100%, 50%)`;
                } else {
                    ctx.fillStyle = index === 0 ? "#00ff00" : "#008000"; // è›‡é ­ç¶ è‰²ï¼Œèº«é«”æ·±ç¶ 
                }
                ctx.fillRect(segment.x * 20, segment.y * 20, 18, 18); // æ¯æ®µ20pxï¼Œç•™2pxé–“è·
            });

            // ç¹ªè£½è›‡ç³§
            if (food) {
                switch(food.type) {
                    case "apple": ctx.fillStyle = "#ff0000"; break; // è˜‹æœ-ç´…è‰²
                    case "blueberry": ctx.fillStyle = "#0000ff"; break; // è—è“-è—è‰²
                    case "strawberry": ctx.fillStyle = "#ff69b4"; break; // è‰è“-ç²‰ç´…è‰²
                    case "colorful": ctx.fillStyle = `hsl(${Math.random() * 360}, 100%, 50%)`; break; // è®Šè‰²ç³§-å½©è™¹è‰²
                }
                ctx.fillRect(food.x * 20, food.y * 20, 18, 18);
            }

            // ç¹ªè£½åˆ†æ•¸å’Œè›‡ç³§æ¦‚ç‡
            ctx.fillStyle = "#ffffff";
            ctx.font = "20px Arial";
            ctx.fillText("åˆ†æ•¸ï¼š" + score, 10, 30);
            ctx.fillText(`è›‡ç³§æ¦‚ç‡ï¼š${Math.round(foodSpawnRate * 100)}%`, canvas.width - 150, 30);
        }

        // æ›´æ–°éŠæˆ²é‚è¼¯
        function updateGame() {
            if (gameOver) return;

            // ç§»å‹•è›‡é ­
            const head = { ...snake[0] };
            switch(direction) {
                case "up": head.y--; break;
                case "down": head.y++; break;
                case "left": head.x--; break;
                case "right": head.x++; break;
            }

            // ç¢°æ’æª¢æ¸¬ï¼ˆé‚Šç•Œ/è‡ªæ’ï¼‰
            if (
                head.x < 0 || head.x >= canvas.width / 20 ||
                head.y < 0 || head.y >= canvas.height / 20 ||
                snake.some(segment => segment.x === head.x && segment.y === head.y)
            ) {
                gameOver = true;
                return;
            }

            // æ·»åŠ æ–°è›‡é ­
            snake.unshift(head);

            // åˆ¤æ–·æ˜¯å¦åƒåˆ°è›‡ç³§
            if (food && head.x === food.x && head.y === food.y) {
                // ä¸åŒè›‡ç³§åŠ åˆ†è¦å‰‡
                switch(food.type) {
                    case "apple": score += 10; break;
                    case "blueberry": score += 20; break;
                    case "strawberry": score += 25; break;
                    case "colorful": score += 50; break;
                }
                spawnFood(); // ç”Ÿæˆæ–°è›‡ç³§
            } else {
                snake.pop(); // æ²’åƒåˆ°å°±åˆªé™¤è›‡å°¾
            }
        }

        // éŠæˆ²ä¸»å¾ªç’°
        function gameLoop() {
            updateGame(); // æ›´æ–°é‚è¼¯
            drawGame();   // ç¹ªè£½ç•«é¢
            if (!gameOver) {
                requestAnimationFrame(gameLoop); // å¾ªç’°èª¿ç”¨
            }
        }

        // é é¢åŠ è¼‰å®Œæˆå¾Œåˆå§‹åŒ–éŠæˆ²
        window.onload = initGame;
    </script>
</body>
</html>